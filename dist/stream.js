"use strict";

const spawn = require('child_process').spawn; //let camera = '/dev/video0';
//let fileName = 'master';


const Room = require('ipfs-pubsub-room');

const watch = require('node-watch');

const fs = require('fs');

const md5 = require('md5');

const ls = require('ls');

class Stream {
  constructor(ipfs, nameOfStreem) {
    let path = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 'videos';
    this.ipfs = ipfs;
    this.ipfsready = false;
    this.headers = '#EXTM3U\n#EXT-X-VERSION:3\n#EXT-X-TARGETDURATION:8\n#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-PLAYLIST-TYPE:EVENT\n';
    this.blocks = {};
    this.rooms = {};
    this.processUpload = 'wait';
    this.keepPath = path + '/' + nameOfStreem + '/';
    this.keep = this.keepPath + 'master.m3u8';
    this.camera = false;
    this.nameOfStreem = nameOfStreem;
    this.m3u8IPFS = this.keepPath + 'streamIPFS.m3u8';
    this.cameras = ls('/dev/video*');

    if (!fs.existsSync(path)) {
      fs.mkdirSync(path);
      if (!fs.existsSync(this.keepPath)) fs.mkdirSync(this.keepPath);
    } else if (!fs.existsSync(this.keepPath)) fs.mkdirSync(this.keepPath);

    this.createRooms();
  }

  getCameraList() {
    return this.cameras;
  }

  setCamera(index) {
    if (this.cameras[index]) {
      this.camera = this.cameras[index].full;
    }
  }

  ffmpeg() {
    let debug = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;
    console.log('send stream to ' + this.keep);
    console.log('Use camera ' + this.camera);
    this.ffmpegProc = spawn('ffmpeg', ['-i', `${this.camera}`, '-profile:v', 'baseline', '-level', '3.0', '-c:v', 'libx264', '-crf', '21', '-preset', 'veryfast', '-c:a', 'aac', '-b:a', '128k', '-ac', '2', '-f', 'hls', '-hls_time', '6', '-hls_playlist_type', 'event', `${this.keep}`]);
    let x = this;
    if (debug) this.ffmpegProc.stderr.on('data', err => {
      err = new String(err);
      console.log('Process:', err);

      if (err.includes('Input/output error')) {
        console.log('Try again');
        x.ffmpegProc.kill();
        x.ffmpeg();
      }
    });
  }

  createRooms() {
    let rooms = ['borgStream', this.nameOfStreem];
    let x = this;
    x.ipfs.once('ready', () => this.ipfs.id((err, peerInfo) => {
      for (var i = 0; i < rooms.length; i++) {
        let nameRoom = rooms[i];
        x.rooms[nameRoom] = Room(x.ipfs, nameRoom);
      }
    }));
  }

  uploadM3U8() {
    let output = this.headers;
    let x = this;

    for (const [key, value] of Object.entries(this.blocks)) {
      output += value;
    }

    output += '#EXT-X-ENDLIST\n';
    fs.writeFile(this.m3u8IPFS, output, function (err) {
      x.ipfs.addFromFs(x.m3u8IPFS, (err, result) => {
        if (err) {
          throw err;
        }

        let data = {
          live: x.ipfsID + "/" + x.nameOfStreem
        };
        x.rooms.borgStream.broadcast(JSON.stringify(data));
        x.rooms[x.nameOfStreem].broadcast(JSON.stringify(result));
      });
    });
    this.processUpload = 'wait';
  }

  isReadyM3U8() {
    let x = this;
    this.isReadyM3U8Interval = setInterval(function () {
      if (x.processUpload == 'executed') {
        let i = Object.keys(x.blocks).length;
        let r = 0;

        for (const [key, value] of Object.entries(x.blocks)) {
          if (value.includes('EXTINF')) r++;
        }

        if (r == i) {
          x.uploadM3U8();
        }
      }
    }, 200);
  }

  start() {
    let x = this;

    if (!this.camera) {
      throw 'Camera is not set';
    }

    x.isReadyM3U8();
    x.ffmpeg(true);
    x.watcher();
  }

  watcher() {
    let x = this;
    x.watcherPID = watch(this.keepPath, function (evt, name) {
      console.log(x.keep + ' -- ' + name);

      if (evt == 'update' && name == x.keep) {
        x.processUpload = 'executed';
        fs.readFile(x.keep, 'utf8', function (err, contents) {
          let blocks = contents.split('#');

          for (var i = 0; i < blocks.length; i++) {
            let element = blocks[i];
            if (element.includes('EXTINF')) x.blocks[md5(element)] = element.split(',');
          }

          for (const [key, value] of Object.entries(x.blocks)) {
            x.ipfs.addFromFs(x.keepPath + value[1].trim(), (err, result) => {
              if (err) {
                throw err;
              }

              console.log('add new chunk with hash ' + result[0].hash);
              let data = '#IPFSHASH-' + result[0].hash + "," + value[1].trim() + "\n" + "#" + value[0] + "," + value[1];
              x.blocks[key] = data;
            });
          }
        });
      }
    });
  }

  stop() {
    clearInterval(this.isReadyM3U8Interval);
    this.ffmpegProc.kill();
    if (this.watcherPID) this.watcherPID.close();
    this.blocks = {};
    this.processUpload = 'wait'; //this.watcherPID = false;
  }

}

module.exports = Stream;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdHJlYW0uanMiXSwibmFtZXMiOlsic3Bhd24iLCJyZXF1aXJlIiwiUm9vbSIsIndhdGNoIiwiZnMiLCJtZDUiLCJscyIsIlN0cmVhbSIsImNvbnN0cnVjdG9yIiwiaXBmcyIsIm5hbWVPZlN0cmVlbSIsInBhdGgiLCJpcGZzcmVhZHkiLCJoZWFkZXJzIiwiYmxvY2tzIiwicm9vbXMiLCJwcm9jZXNzVXBsb2FkIiwia2VlcFBhdGgiLCJrZWVwIiwiY2FtZXJhIiwibTN1OElQRlMiLCJjYW1lcmFzIiwiZXhpc3RzU3luYyIsIm1rZGlyU3luYyIsImNyZWF0ZVJvb21zIiwiZ2V0Q2FtZXJhTGlzdCIsInNldENhbWVyYSIsImluZGV4IiwiZnVsbCIsImZmbXBlZyIsImRlYnVnIiwiY29uc29sZSIsImxvZyIsImZmbXBlZ1Byb2MiLCJ4Iiwic3RkZXJyIiwib24iLCJlcnIiLCJTdHJpbmciLCJpbmNsdWRlcyIsImtpbGwiLCJvbmNlIiwiaWQiLCJwZWVySW5mbyIsImkiLCJsZW5ndGgiLCJuYW1lUm9vbSIsInVwbG9hZE0zVTgiLCJvdXRwdXQiLCJrZXkiLCJ2YWx1ZSIsIk9iamVjdCIsImVudHJpZXMiLCJ3cml0ZUZpbGUiLCJhZGRGcm9tRnMiLCJyZXN1bHQiLCJkYXRhIiwibGl2ZSIsImlwZnNJRCIsImJvcmdTdHJlYW0iLCJicm9hZGNhc3QiLCJKU09OIiwic3RyaW5naWZ5IiwiaXNSZWFkeU0zVTgiLCJpc1JlYWR5TTNVOEludGVydmFsIiwic2V0SW50ZXJ2YWwiLCJrZXlzIiwiciIsInN0YXJ0Iiwid2F0Y2hlciIsIndhdGNoZXJQSUQiLCJldnQiLCJuYW1lIiwicmVhZEZpbGUiLCJjb250ZW50cyIsInNwbGl0IiwiZWxlbWVudCIsInRyaW0iLCJoYXNoIiwic3RvcCIsImNsZWFySW50ZXJ2YWwiLCJjbG9zZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTUEsS0FBSyxHQUFHQyxPQUFPLENBQUMsZUFBRCxD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LENBQU4sQ0FBVXVCLElBQXZCLEdBQTRCLEdBQTVCLEdBQWdDNUIsS0FBSyxDQUFDLENBQUQsQ0FBTCxDQUFTMkIsSUFBVCxFQUFoQyxHQUFnRCxJQUFoRCxHQUFxRCxHQUFyRCxHQUF5RDNCLEtBQUssQ0FBQyxDQUFELENBQTlELEdBQWtFLEdBQWxFLEdBQXNFQSxLQUFLLENBQUMsQ0FBRCxDQUF0RjtBQUVBaEIsY0FBQUEsQ0FBQyxDQUFDcEIsTUFBRixDQUFTbUMsR0FBVCxJQUFnQk8sSUFBaEI7QUFFQSxhQVJEO0FBVUE7QUFHRCxTQTNCRDtBQTRCQTtBQUNELEtBcENtQixDQUFwQjtBQXNDQTs7QUFFRHVCLEVBQUFBLElBQUksR0FBRTtBQUNMQyxJQUFBQSxhQUFhLENBQUMsS0FBS2hCLG1CQUFOLENBQWI7QUFDQSxTQUFLL0IsVUFBTCxDQUFnQk8sSUFBaEI7QUFFQSxRQUFJLEtBQUs4QixVQUFULEVBQ0MsS0FBS0EsVUFBTCxDQUFnQlcsS0FBaEI7QUFDRCxTQUFLbkUsTUFBTCxHQUFjLEVBQWQ7QUFDQSxTQUFLRSxhQUFMLEdBQXFCLE1BQXJCLENBUEssQ0FTTDtBQUdBOztBQTdQVzs7QUFpUWJrRSxNQUFNLENBQUNDLE9BQVAsR0FBaUI1RSxNQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHNwYXduID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpLnNwYXduO1xuIFxuLy9sZXQgY2FtZXJhID0gJy9kZXYvdmlkZW8wJztcbi8vbGV0IGZpbGVOYW1lID0gJ21hc3Rlcic7XG5cbmNvbnN0IFJvb20gPSByZXF1aXJlKCdpcGZzLXB1YnN1Yi1yb29tJylcbmNvbnN0IHdhdGNoID0gcmVxdWlyZSgnbm9kZS13YXRjaCcpO1xuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1x0XG5jb25zdCBtZDUgPSByZXF1aXJlKCdtZDUnKTtcdCBcbmNvbnN0IGxzID0gcmVxdWlyZSgnbHMnKTtcblxuXG5jbGFzcyBTdHJlYW0ge1xuXG5cdGNvbnN0cnVjdG9yKGlwZnMsIG5hbWVPZlN0cmVlbSwgcGF0aCA9ICd2aWRlb3MnKXtcblxuXHRcdHRoaXMuaXBmcyA9IGlwZnM7XG5cdFx0dGhpcy5pcGZzcmVhZHkgPSBmYWxzZTtcblxuXHRcdHRoaXMuaGVhZGVycyA9ICcjRVhUTTNVXFxuI0VYVC1YLVZFUlNJT046M1xcbiNFWFQtWC1UQVJHRVREVVJBVElPTjo4XFxuI0VYVC1YLU1FRElBLVNFUVVFTkNFOjBcXG4jRVhULVgtUExBWUxJU1QtVFlQRTpFVkVOVFxcbic7XG5cdFx0dGhpcy5ibG9ja3MgPSB7fTtcblx0XHR0aGlzLnJvb21zID0ge307XG5cdFx0dGhpcy5wcm9jZXNzVXBsb2FkID0gJ3dhaXQnO1xuXG5cdFx0dGhpcy5rZWVwUGF0aCA9IHBhdGgrJy8nK25hbWVPZlN0cmVlbSsnLyc7XG5cdFx0dGhpcy5rZWVwID0gdGhpcy5rZWVwUGF0aCsnbWFzdGVyLm0zdTgnO1xuXHRcdFxuXHRcdHRoaXMuY2FtZXJhID0gZmFsc2U7XG5cdFx0dGhpcy5uYW1lT2ZTdHJlZW0gPSBuYW1lT2ZTdHJlZW07XG5cdFx0dGhpcy5tM3U4SVBGUyA9IHRoaXMua2VlcFBhdGggKyAnc3RyZWFtSVBGUy5tM3U4JztcdFx0XG5cdFx0dGhpcy5jYW1lcmFzID0gbHMoJy9kZXYvdmlkZW8qJyk7XG5cblxuXHRcdGlmICghZnMuZXhpc3RzU3luYyhwYXRoKSl7XG5cdFx0ICAgIGZzLm1rZGlyU3luYyhwYXRoKTtcblxuXG5cdFx0ICAgIGlmICghZnMuZXhpc3RzU3luYyh0aGlzLmtlZXBQYXRoKSlcblx0XHQgICAgXHRmcy5ta2RpclN5bmModGhpcy5rZWVwUGF0aCk7XG5cdFx0ICAgIFxuXG5cdFx0fWVsc2UgaWYoIWZzLmV4aXN0c1N5bmModGhpcy5rZWVwUGF0aCkpXG5cdFx0XHRmcy5ta2RpclN5bmModGhpcy5rZWVwUGF0aCk7XG5cdFx0ICAgIFxuXHRcdFxuXHRcdHRoaXMuY3JlYXRlUm9vbXMoKVxuXG5cdH1cblxuXG5cdGdldENhbWVyYUxpc3QoKXtcblx0XHRyZXR1cm4gdGhpcy5jYW1lcmFzXG5cdH1cblxuXG5cdHNldENhbWVyYShpbmRleCl7XG5cdFx0aWYoIHRoaXMuY2FtZXJhc1tpbmRleF0gKXtcblx0XHRcdHRoaXMuY2FtZXJhID0gdGhpcy5jYW1lcmFzW2luZGV4XS5mdWxsO1xuXHRcdH1cblx0fVxuXG5cdGZmbXBlZyggZGVidWcgPSAwKXtcblx0XHRcblxuXHRcdGNvbnNvbGUubG9nKCdzZW5kIHN0cmVhbSB0byAnK3RoaXMua2VlcCk7XG5cdFx0Y29uc29sZS5sb2coJ1VzZSBjYW1lcmEgJyArIHRoaXMuY2FtZXJhKVxuXG5cdFx0dGhpcy5mZm1wZWdQcm9jID0gc3Bhd24oJ2ZmbXBlZycsIFxuXHRcdFx0W1xuXHRcdFx0XHQnLWknLCBgJHsgdGhpcy5jYW1lcmEgfWAsIFxuXHRcdFx0XHQnLXByb2ZpbGU6dicsICdiYXNlbGluZScsXG5cdFx0XHRcdCctbGV2ZWwnLCAnMy4wJyxcblx0XHRcdFx0Jy1jOnYnLCAnbGlieDI2NCcsXG5cdFx0XHRcdCctY3JmJywnMjEnLFxuXHRcdFx0XHQnLXByZXNldCcsJ3ZlcnlmYXN0Jyxcblx0XHRcdFx0Jy1jOmEnLCAnYWFjJywgXG5cdFx0XHRcdCctYjphJywgJzEyOGsnLCBcblx0XHRcdFx0Jy1hYycsJzInLFxuXHRcdFx0XHQnLWYnLCAnaGxzJywgXG5cdFx0XHRcdCctaGxzX3RpbWUnLCAnNicsIFxuXHRcdFx0XHQnLWhsc19wbGF5bGlzdF90eXBlJywgJ2V2ZW50JywgXG5cdFx0XHRcdGAkeyB0aGlzLmtlZXAgfWBcblx0XHRcdF0pO1xuXG5cblx0XHRsZXQgeCA9IHRoaXM7XG5cblxuXHRcdGlmKCBkZWJ1ZyApXG5cdFx0XHR0aGlzLmZmbXBlZ1Byb2Ncblx0XHRcdCAgLnN0ZGVyclxuXHRcdFx0ICAub24oJ2RhdGEnLCAoZXJyKSA9PiB7XG5cblx0XHRcdCAgXHRlcnIgPSBuZXcgU3RyaW5nKGVycik7XG5cblx0XHRcdFx0Y29uc29sZS5sb2coJ1Byb2Nlc3M6JywgZXJyKVxuXG5cdFx0XHQgIFx0aWYoIGVyci5pbmNsdWRlcygnSW5wdXQvb3V0cHV0IGVycm9yJykgKXtcblx0XHRcdCAgXHRcdGNvbnNvbGUubG9nKCdUcnkgYWdhaW4nKTtcblxuXG5cdFx0XHQgIFx0XHR4LmZmbXBlZ1Byb2Mua2lsbCgpO1xuXG5cdFx0XHQgIFx0XHR4LmZmbXBlZygpO1xuXG5cdFx0XHQgIFx0fVxuXG5cdFx0XHQgICAgXG5cdFx0XHQgIH0pXG5cdH1cblxuXG5cdGNyZWF0ZVJvb21zKCl7XG5cblx0XHRsZXQgcm9vbXMgPSBbJ2JvcmdTdHJlYW0nLHRoaXMubmFtZU9mU3RyZWVtXTtcblx0XHRsZXQgeCA9IHRoaXM7XG5cblx0XHR4LmlwZnMub25jZSgncmVhZHknLCAoKSA9PiB0aGlzLmlwZnMuaWQoKGVyciwgcGVlckluZm8pID0+IHtcblx0XHRcdGZvciAodmFyIGkgPSAwOyBpIDwgcm9vbXMubGVuZ3RoOyBpKyspIHtcblx0XHRcdFx0bGV0IG5hbWVSb29tID0gcm9vbXNbaV07XG5cdFx0XHRcdHgucm9vbXNbbmFtZVJvb21dID0gUm9vbSh4LmlwZnMsIG5hbWVSb29tKTtcblx0XHRcdH1cblxuXG5cdFx0fSkpXG5cblx0fVxuXG5cblx0dXBsb2FkTTNVOCgpe1xuXG5cdFx0bGV0IG91dHB1dCA9IHRoaXMuaGVhZGVycztcblx0XHRsZXQgeCA9IHRoaXM7XG5cblx0XHRmb3IoIGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLmJsb2NrcykgKXtcblx0XHRcdG91dHB1dCArPSB2YWx1ZTtcblxuXHRcdH1cblxuXHRcdG91dHB1dCArPSAnI0VYVC1YLUVORExJU1RcXG4nO1xuXG5cblx0ICAgIGZzLndyaXRlRmlsZSh0aGlzLm0zdThJUEZTLCBvdXRwdXQsIGZ1bmN0aW9uKGVycikge1xuXG5cblx0XHRcdHguaXBmcy5hZGRGcm9tRnMoeC5tM3U4SVBGUywgKGVyciwgcmVzdWx0KSA9PiB7XG5cdFx0XHQgIGlmIChlcnIpIHsgdGhyb3cgZXJyIH1cblxuXHRcdFx0ICBcdGxldCBkYXRhID0ge1xuXHRcdFx0ICBcdFx0bGl2ZSA6IHguaXBmc0lEK1wiL1wiK3gubmFtZU9mU3RyZWVtXG5cdFx0XHQgIFx0fTtcblxuXHRcdFx0ICBcdHgucm9vbXMuYm9yZ1N0cmVhbS5icm9hZGNhc3QoSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xuXHRcdFx0ICBcdHgucm9vbXNbeC5uYW1lT2ZTdHJlZW1dLmJyb2FkY2FzdChKU09OLnN0cmluZ2lmeShyZXN1bHQpKTtcblx0XHRcdH0pXHRcblxuXG5cdCAgICB9KTsgXHRcdFxuXG5cdFx0dGhpcy5wcm9jZXNzVXBsb2FkID0gJ3dhaXQnO1xuXHR9XG5cblxuXHRpc1JlYWR5TTNVOCgpe1xuXG5cdFx0bGV0IHggPSB0aGlzO1xuXHRcdFxuXHRcdHRoaXMuaXNSZWFkeU0zVThJbnRlcnZhbCA9XHRzZXRJbnRlcnZhbChmdW5jdGlvbigpe1xuXHRcdFx0XHRcblx0XHRcdGlmKCB4LnByb2Nlc3NVcGxvYWQgPT0gJ2V4ZWN1dGVkJyl7XG5cdFx0XHRcdGxldCBpID0gT2JqZWN0LmtleXMoeC5ibG9ja3MpLmxlbmd0aDtcblx0XHRcdFx0bGV0IHIgPSAwO1xuXG5cdFx0XHRcdGZvciggY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHguYmxvY2tzKSApe1xuXG5cdFx0XHRcdFx0aWYoIHZhbHVlLmluY2x1ZGVzKCdFWFRJTkYnKSApIFxuXHRcdFx0XHRcdFx0cisrO1xuXHRcdFx0XHR9XG5cblxuXHRcdFx0XHRpZiggciA9PSBpICl7XG5cdFx0XHRcdFx0eC51cGxvYWRNM1U4KClcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0fSwyMDApXG5cdH1cblxuXHRzdGFydCgpe1xuXG5cdFx0bGV0IHggPSB0aGlzO1xuXG5cblx0XHRpZighdGhpcy5jYW1lcmEpe1xuXHRcdFx0dGhyb3cgJ0NhbWVyYSBpcyBub3Qgc2V0Jztcblx0XHR9XG5cdFx0XG5cdFx0XG5cdFx0XG5cdFx0eC5pc1JlYWR5TTNVOCgpXG5cdFx0eC5mZm1wZWcodHJ1ZSk7XG5cdFx0eC53YXRjaGVyKClcblxuXHR9XG5cblxuXHR3YXRjaGVyKCl7XG5cblxuXG5cdFx0bGV0IHggPSB0aGlzO1xuXG5cblx0XHR4LndhdGNoZXJQSUQgPSB3YXRjaCh0aGlzLmtlZXBQYXRoLCBmdW5jdGlvbihldnQsIG5hbWUpIHtcblxuXHRcdFx0Y29uc29sZS5sb2coeC5rZWVwICsgJyAtLSAnK25hbWUpXG5cblx0XHRcdGlmKCBldnQgPT0gJ3VwZGF0ZScgJiYgbmFtZSA9PSB4LmtlZXApe1xuXHRcdFx0XHRcblx0XHRcdFx0eC5wcm9jZXNzVXBsb2FkID0gJ2V4ZWN1dGVkJztcblx0XHRcdFx0ZnMucmVhZEZpbGUoeC5rZWVwLCAndXRmOCcsIGZ1bmN0aW9uKGVyciwgY29udGVudHMpIHtcdFx0XHRcdFxuXG5cdFx0XHRcdFx0bGV0IGJsb2NrcyA9IGNvbnRlbnRzLnNwbGl0KCcjJyk7XG5cblxuXHRcdFx0XHQgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBibG9ja3MubGVuZ3RoOyBpKyspIHtcblx0XHRcdFx0ICAgIFx0bGV0IGVsZW1lbnQgPSBibG9ja3NbaV07XG5cblx0XHRcdFx0ICAgIFx0aWYoIGVsZW1lbnQuaW5jbHVkZXMoJ0VYVElORicpICkgIFx0XHRcblx0ICBcdFx0XHRcdFx0XHR4LmJsb2Nrc1ttZDUoZWxlbWVudCldID0gZWxlbWVudC5zcGxpdCgnLCcpO1xuXHRcdFx0XHQgICAgfVxuXG5cdFx0XHRcdFx0Zm9yKCBjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoeC5ibG9ja3MpICl7XG5cblx0XHRcdFx0XHRcdHguaXBmcy5hZGRGcm9tRnMoeC5rZWVwUGF0aCt2YWx1ZVsxXS50cmltKCksIChlcnIsIHJlc3VsdCkgPT4ge1xuXHRcdFx0XHRcdFx0ICBpZiAoZXJyKSB7IHRocm93IGVyciB9XG5cdFx0XHRcdFx0XHQgIGNvbnNvbGUubG9nKCdhZGQgbmV3IGNodW5rIHdpdGggaGFzaCAnKyByZXN1bHRbMF0uaGFzaClcblxuXHRcdFx0XHRcdFx0XHRsZXQgZGF0YSA9ICcjSVBGU0hBU0gtJytyZXN1bHRbMF0uaGFzaCtcIixcIit2YWx1ZVsxXS50cmltKCkrXCJcXG5cIitcIiNcIit2YWx1ZVswXStcIixcIit2YWx1ZVsxXTtcblxuXHRcdFx0XHRcdFx0XHR4LmJsb2Nrc1trZXldID0gZGF0YTsgXG5cblx0XHRcdFx0XHRcdH0pXHRcdCAgXHRcdFx0XHRcdFx0XG5cblx0XHRcdFx0XHR9XG5cblxuXHRcdFx0XHR9KVxuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdH1cblxuXHRzdG9wKCl7XG5cdFx0Y2xlYXJJbnRlcnZhbCh0aGlzLmlzUmVhZHlNM1U4SW50ZXJ2YWwpO1xuXHRcdHRoaXMuZmZtcGVnUHJvYy5raWxsKClcblxuXHRcdGlmKCB0aGlzLndhdGNoZXJQSUQgKVxuXHRcdFx0dGhpcy53YXRjaGVyUElELmNsb3NlKClcblx0XHR0aGlzLmJsb2NrcyA9IHt9O1xuXHRcdHRoaXMucHJvY2Vzc1VwbG9hZCA9ICd3YWl0JztcblxuXHRcdC8vdGhpcy53YXRjaGVyUElEID0gZmFsc2U7XG5cblxuXHR9XG5cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTdHJlYW07Il19